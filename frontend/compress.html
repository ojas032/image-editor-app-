<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Compress Image ‚Äî ImageNerd</title>
    <meta name="description" content="Compress images online with ImageNerd. Reduce size without losing visible quality." />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='https://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üñºÔ∏è</text></svg>" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css?v=1.0.2" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="index.html"><span class="brand-mark">üñºÔ∏è</span><span class="brand-name">ImageNerd</span></a>
        <nav class="main-nav"><!-- <a href="remove-background.html">Remove background</a> --><a href="compress.html">Compress</a><a href="resize.html">Resize</a><a href="crop.html">Crop</a><a href="convert.html">Format Converter</a></nav>
        <div class="header-cta"><button id="themeToggle" class="btn btn-ghost" type="button">Toggle theme</button></div>
        <button class="nav-toggle" aria-label="Toggle menu" aria-expanded="false">‚ò∞</button>
      </div>
    </header>
    <main class="container tool-page-container">
      <h1>Compress image</h1>
      <p class="subtitle">Reduce file size while maintaining quality. Perfect for web optimization.</p>

      <section id="compressSection" aria-label="Image compressor" style="margin-top:24px;">
        <div class="compress-card" role="region" aria-live="polite">
          <!-- Uploader (shown initially, hidden after upload) -->
          <div class="compress-uploader" id="dropZone">
            <input id="fileInput" type="file" accept="image/*" style="position:absolute;opacity:0;pointer-events:none;width:1px;height:1px" aria-hidden="true" />
            <button class="btn btn-primary" id="selectBtn" type="button" aria-controls="fileInput" aria-label="Select image to compress">Select image</button>
            <div class="compress-help">or drop image here</div>
          </div>

          <!-- Editor (hidden initially, shown after upload) -->
          <div id="editorView" style="display:none;max-width:700px;margin:0 auto;text-align:center;">
            
            <!-- Processing overlay -->
            <div id="processingOverlay" style="display:flex;flex-direction:column;align-items:center;padding:40px;">
              <div style="display:inline-block;width:48px;height:48px;border:4px solid var(--primary-500);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;margin-bottom:16px"></div>
              <div style="font-weight:600;font-size:18px;color:var(--light-text);">Compressing your image...</div>
            </div>

            <!-- Success view (hidden until compressed) -->
            <div id="successView" style="display:none;">
              <!-- Big success message -->
              <div style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:#fff;border-radius:12px;padding:32px;margin-bottom:24px;">
                <div style="font-size:20px;font-weight:600;margin-bottom:8px;">‚úì Saved</div>
                <div style="font-size:32px;font-weight:700;margin-bottom:16px;">Your image is now <span id="reductionPercent">82</span>% smaller!</div>
                <div style="font-size:18px;opacity:0.9;">
                  <span id="originalSizeDisplay">818.94 KB</span> ‚Üí <span id="compressedSizeDisplay">148.47 KB</span>
                </div>
              </div>

              <!-- Preview image -->
              <div style="margin-bottom:24px;">
                <img id="compressedImg" src="" alt="Compressed" style="max-width:100%;max-height:400px;border:1px solid var(--light-border);border-radius:8px;" />
              </div>

              <!-- Action buttons -->
              <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                <a class="btn btn-primary" id="downloadBtn" href="#" download style="font-size:16px;padding:12px 24px;">Download Image</a>
                <button class="btn btn-ghost" id="changeImageBtn" type="button" style="font-size:16px;padding:12px 24px;">Compress Another</button>
              </div>
            </div>
          </div>
        </div>
      </section>

    </main>
    <footer class="site-footer"><div class="container footer-inner"><p>¬© <span id="year"></span> ImageNerd.</p></div></footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="script.js?v=1.0.9"></script>
    <script>
      // Utility styles
      (function(){
        var style = document.createElement('style');
        style.textContent = `
        .compress-card{border:1px solid var(--light-border);background:var(--light-card);border-radius:14px;padding:22px}
        .compress-uploader{border:2px dashed var(--light-border);border-radius:12px;padding:28px;text-align:center;background:rgba(15,23,42,0.02)}
        .compress-uploader.drag{background:rgba(91,140,255,0.10);border-color:#a5b4fc}
        .compress-help{margin-top:10px;color:var(--light-muted);font-size:14px}
        .compress-controls{background:rgba(15,23,42,0.02);border:1px solid var(--light-border);border-radius:10px;padding:20px}
        .control-group label{display:block;font-weight:600;margin-bottom:6px;font-size:14px}
        .control-group small{display:block;margin-top:4px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .theme-dark .compress-card{border-color:var(--border-700);background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01))}
        .theme-dark .compress-uploader{border-color:var(--border-700);background:rgba(255,255,255,0.02)}
        .theme-dark .compress-uploader.drag{background:rgba(91,140,255,0.15);border-color:#5b8cff}
        .theme-dark .compress-help{color:var(--text-300)}
        .theme-dark .compress-controls{background:rgba(255,255,255,0.02);border-color:var(--border-700)}
        .theme-dark #originalImg,.theme-dark #compressedImg{border-color:var(--border-700)}
        .theme-dark #statsContainer{background:rgba(255,255,255,0.02);border-color:var(--border-700)}
        `;
        document.head.appendChild(style);
      })();

      // Main functionality
      (function(){
        const fileInput = document.getElementById('fileInput');
        const selectBtn = document.getElementById('selectBtn');
        const dropZone = document.getElementById('dropZone');
        const editorView = document.getElementById('editorView');
        const processingOverlay = document.getElementById('processingOverlay');
        const successView = document.getElementById('successView');
        const compressedImg = document.getElementById('compressedImg');
        const changeImageBtn = document.getElementById('changeImageBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const reductionPercent = document.getElementById('reductionPercent');
        const originalSizeDisplay = document.getElementById('originalSizeDisplay');
        const compressedSizeDisplay = document.getElementById('compressedSizeDisplay');

        const API_BASE = 'https://api.imagenerd.in';
        const ENDPOINT_COMPRESS = '/compress';

        let currentFile = null;
        let currentBase64 = '';
        let originalFileSize = 0;

        // File selection
        selectBtn.addEventListener('click', () => fileInput.click());
        changeImageBtn.addEventListener('click', () => {
          // Reset to uploader
          dropZone.style.display = 'block';
          editorView.style.display = 'none';
          successView.style.display = 'none';
          fileInput.value = '';
        });

        // Drag and drop
        dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('drag'); });
        dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('drag'));
        dropZone.addEventListener('drop', (e)=>{ e.preventDefault(); dropZone.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', ()=> handleFiles(fileInput.files));

        function handleFiles(list){
          const files = Array.from(list || []).filter(f=>/^image\//.test(f.type));
          if(!files.length) return;
          processFile(files[0]);
        }

        async function processFile(file){
          currentFile = file;
          originalFileSize = file.size;
          
          // Apply EXIF orientation correction
          currentBase64 = await fileToBase64WithOrientation(file);
          
          // Show editor with processing overlay, hide uploader
          dropZone.style.display = 'none';
          editorView.style.display = 'block';
          processingOverlay.style.display = 'flex';
          successView.style.display = 'none';

          // Auto-compress immediately
          compressImage();
        }

        function fileToBase64(file){
          return new Promise((resolve, reject)=>{
            const reader = new FileReader();
            reader.onload = ()=> resolve(String(reader.result).split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }

        // Apply EXIF orientation correction - ALWAYS normalize to orientation 1
        async function fileToBase64WithOrientation(file) {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const img = new Image();
              img.onload = () => {
                // Create canvas with same dimensions
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas to image dimensions
                canvas.width = img.naturalWidth || img.width;
                canvas.height = img.naturalHeight || img.height;
                
                // Draw image (browser handles EXIF automatically)
                ctx.drawImage(img, 0, 0);
                
                // Get base64 without EXIF metadata
                const base64 = canvas.toDataURL(file.type || 'image/jpeg', 0.95).split(',')[1];
                resolve(base64);
              };
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);
          });
        }

        function formatFileSize(bytes){
          if(bytes < 1024) return bytes + ' B';
          if(bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        async function compressImage(){
          if(!currentBase64) return;

          try{
            const isPNG = currentFile.type.includes('png');
            
            // Use smart, balanced compression - quality 88% for good balance
            const body = { 
              image_base64: currentBase64,
              quality: 88
            };

            // Convert PNG to JPEG for better compression (most common case)
            if(isPNG) {
              body.format = 'jpeg';
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000);

            const res = await fetch(API_BASE + ENDPOINT_COMPRESS, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
              signal: controller.signal
            });
            clearTimeout(timeoutId);

            const data = await res.json();
            if(!data.compressed_image_base64) throw new Error(data.error || 'Compression failed');

            // Calculate compressed size
            const compressedSize = Math.round((data.compressed_image_base64.length * 3) / 4);
            const reduction = ((originalFileSize - compressedSize) / originalFileSize * 100).toFixed(0);

            // Check if compression actually reduced size
            if(compressedSize >= originalFileSize) {
              throw new Error('Unable to reduce file size. The image may already be optimized.');
            }

            // Determine output format
            const outputFormat = body.format || (isPNG ? 'png' : 'jpeg');
            const mimeType = outputFormat === 'jpeg' ? 'image/jpeg' : 'image/png';
            const fileExt = outputFormat === 'jpeg' ? 'jpg' : 'png';

            // Update UI
            const downloadUrl = `data:${mimeType};base64,${data.compressed_image_base64}`;
            compressedImg.src = downloadUrl;

            reductionPercent.textContent = reduction;
            originalSizeDisplay.textContent = formatFileSize(originalFileSize);
            compressedSizeDisplay.textContent = formatFileSize(compressedSize);

            // Setup download
            downloadBtn.href = downloadUrl;
            downloadBtn.download = (currentFile.name||'image').replace(/\.[^.]+$/, '') + '-compressed.' + fileExt;

            // Show success view
            processingOverlay.style.display = 'none';
            successView.style.display = 'block';
          }catch(err){
            console.error(err);
            processingOverlay.style.display = 'none';
            if (err.name === 'AbortError') {
              alert('Request timed out after 20 seconds. Please try again.');
            } else {
              alert('Failed to compress image: ' + err.message);
            }
            // Reset to uploader
            dropZone.style.display = 'block';
            editorView.style.display = 'none';
          }
        }
      })();
    </script>
  </body>
  </html>



